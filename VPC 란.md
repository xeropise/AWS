## Amazon VPC

![Picture2-2](https://user-images.githubusercontent.com/50399804/134214722-775e4c07-78d5-4612-997b-2ed8f10aea4b.png)

- AWS가 제공하는 AWS 계정 전용 가상 네트워크

  

- 네트워크와 서브넷 범위, 라우팅 테이블, 네트워크 게이트웨이 등 가상 네트워킹 환경을 설정할 수 있다.

  

- 웹 서버나 데이터베이스 서버와 같은 서버들은 네트워크에 연결되어 있어야 한다.

  

- 한 장소에 모아서 네트워크를 연결하는 것도 가능하지만 그렇게 되면 서버로서의 의미가 없다.

  

- AWS 서비스인 EC2 나 RDS(Relational Database Service) 도 마찬가지로 네트워크에 연결되어 있어야 한다.

  

- 이러한 네트워크를 구축하기 위해 사용되는 것이 Amazon Virtual Private Cloud(Amazon VPC)이다.

  

- AWS 계정 전용 가상 네트워크 서비스로, AWS에서 제공하는 리소스만 설치할 수 있다.

  

- EC2 나 RDS 의 경우 VPC를 선택하지 않으면 서버를 생성할 수 없기 때문에 리소스를 사용하기 위해서는 반드시 필요한 서비스이다.

<br>

---

### VPC의 구성

- VPC 내에 서버를 설치하면 해당 네트워크에 소속되지만, 별도로 설정하지 않으면 VPC 자체는 격리된 네트워크가 된다.

  

- 외부와 통신하려면 VPC를 인터넷 혹은 회사 LAN과 연결해야 한다.

<br>

---

### VPC의 기능

- VPC는 네트워크와 서브넷 범위, 라우팅 테이블, 네트워크 게이트웨이 등과 같은 가상 네트워킹 환경을 성절할 수 있다.

  

- 물리적인 네트워크와 다른 점도 있지만, 기본적인 개념은 같다. IPv4와 IPv6 둘 다 사용할 수 있다.

  

| 항목                                              | 내용                                                                                                                                                                                                                                                                    |
| ------------------------------------------------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| CIDR 블록                                         | [서브넷](https://hyoje420.tistory.com/32)으로 네트워크를 나눈 범위 이다. <br>VPC를 생성할 때 네트워크 범위를 CIDR로 정하고 이를 더 작은 서브넷으로 나누어 사용한다.                                                                                                     |
| [서브넷 마스크](https://limkydev.tistory.com/166) | 네트워크의 크기를 계산하는 값이다. CIDR은 서브넷 마스크의 표기법 중 하나이다.                                                                                                                                                                                           |
| 가용 영역                                         | 서브넷이 구축된 물리적 장소이다.                                                                                                                                                                                                                                        |
| 인터넷 게이트웨이                                 | 인터넷에 접속하기 위한 출입구, VPC를 인터넷에 연결하지 않을 경우에는 불필요하다.                                                                                                                                                                                        |
| 라우팅                                            | 어떤 데이터를 어디에 보낼지 조정한다.<br>인터넷 게이트웨이와 라우팅으로 데이터 송수신을 설정하지 않으면 VPC가 인터넷에 접속되지 않는다.<br>가정이나 기업의 라우터(가정의 경우 공유기) 장비가 이 역할을 수행하는 경우가 많지만<br>AWS는 소프트웨어가 이 기능을 담당한다. |
| 라우팅 테이블                                     | 라우팅에 대한 설정이 기록된 테이블이다.                                                                                                                                                                                                                                 |
| 보안 그룹                                         | AWS가 제공하는 가상 방홥겨이다.<br>인스턴스 단위로 설정하여 유입되는 데이터는 '거부' 가 기본 설정이다.                                                                                                                                                                  |
| 네트워크 ACL                                      | AWS가 제공하는 가상 방화벽이다. 서브넷 단위로 설정된다.                                                                                                                                                                                                                 |

<br>

---

### VPC 네트워크의 특징과 라우팅 테이블

- VPC 네트워크는 클라우드이기 때문에 일반 네트워크와는 조금 차이가 있다.

  - 그중 가장 큰 차이점은 라우터이다.

    

- VPC는 물리적인 라우터가 아닌 소프트웨어가 라우터 역할을 하며 라우팅을 수행한다.

  

- 라우팅은 설정된 라우팅 테이블에 따라 동작하는데, 라우팅 테이블 하나에 서브넷 여러 개를 설정할 수 있다.

  

- 물리적인 서버의 경우 LAN 케이블과 와이파이로 라우터와 연결하겠지만, 클라우드는 라우팅 테이블로 연결한다.

  

- 일반적인 서브넷 사이의 통신은 라우터로 이루어지지만, VPC의 경우 라우터 없이 직접 통신할 수 있다.

  

- VPC 하나에 인터넷 게이트웨이 한 개만 설정할 수 있다.

  

- 라우터와 인터넷 게이트웨이는 명시적인 IP 주소가 부여되지 않는다. 이는 클라우드의 특징이다.

  

- VPC 네트워크의 특징은 다음과 같다.

  - 소프트웨어가 라우팅한다. 라우터는 IP주소를 갖지 않는다.

  - 라우팅 테이블 한 개에 서브넷 여러 개를 설정할 수 있다.

  - VPC 한 개에 인터넷 게이트웨이는 한 개만 설정할 수 있고, IP 주소를 갖지 않는다.

  - 서브넷 사이의 통신은 라우터 없이 직접 통신할 수 있다.

<br>

---

### VPC의 사용 절차: 가상 네트워크를 사용하자.

- VPC를 사용하려면 관리 콘솔에서 별도로 설정해야 한다. 이때 중요한 설정이 서브넷이다.

  

- 서브넷 설정은 CIDR(Classless Inter-Domain Routing) 블록에 네트워크 범위를 설정한 후에 서브넷을 나눈다.

  

- VPC는 네트워크이므로 서버(인스턴스)가 어떤 환경에 설치되어 있는지, 그리고 인터넷에 연결해야 하는지에 대한 설정이 필요하다.

  

- 특히 중요한 것은 인터넷 연결 여부와 오토 스케일링이다.

  - 인터넷에 연결해야 한다면 인터넷 게이트웨이를 설정해야 하고, 오토 스케일링을 설정하면 서버가 자동으로 늘어나기 때문에 IP 주소를 많이 확보해 두어야 한다.
  
    
  
- 보안 그룹과 네트워크 ACL을 설정하려면, 인스턴스 용도에 맞는 포트를 설정하는 것도 고려해야 한다.

  - 모든 포트가 닫힌 것이 기본 설정이므로 서버를 사용하려면 기본 설정을 변경해야 한다.

    

  - 다만, VPC는 기본 VPC를 비롯해 기본 서브넷과 보안 그룹도 제공한다.

  

<br>



- VPC의 사용 절차는 다음과 같다.

  - VPC 이름을 정하고 CIDR 블록에 네트워크 범위를 설정한다.

    

  - 네트워크를 작게 서브넷으로 나눈다. (큰 사무실이 있고 업무별로 파티션을 나눈다고 생각하자.)

    

  - 인터넷에 접속하려면 인터넷 게이트웨이를 생성하고 라우팅을 설정(라우팅 테이블과 매핑)해야 한다.

    

  - 그 외에 보안도 설정(보안 그룹, 네트워크 ACL)해야 한다.



<br>

***

### 기본 VPC: AWS가 제공하는 기본 VPC

- AWS는 네트워크에 대한 지식이 없이도 이용할 수 있도록 리전별로 기본 VPC를 제공한다.

  

- 특별한 요건이 없는 이상, 기본 VPC를 사용하는 편이 좋다. 기본 VPC에서 Elastic Load Balancing(ELB)와 같은 서비스도 사용할 수 있다.



- 기본 VPC는 서브넷과 인터넷 게이트웨이가 기본적으로 구성되어 있다. 대시보드에서 EC2를 생성할 때나 RDS를 생성할 때도 기본 VPC를 선택할 수 있다.

  

- 네트워크의 범위는 사설 IP 주소 172.31.0.0/16이 부여된다. 기본 VPC는 기본 서브넷이라는 서브넷이 가용 영역별로 한 개씩 생성되어 있다.

  - 서울 리전의 경우 총 4군데로 각 서브넷은 /20의 주소 범위로 설정되어 있다.



| 네트워크                 | CIDR           | 네트워크의 범위             |
| ------------------------ | -------------- | --------------------------- |
| VPC 전체의 네트워크 범위 | 172.31.0.0/16  | 172.31.0.0 ~ 172.31.255.255 |
| 서브넷 1                 | 172.31.0.0/20  | 172.31.0.0 ~ 172.31.15.255  |
| 서브넷 2                 | 172.31.16.0/20 | 172.31.16.0 ~ 172.31.31.255 |
| 서브넷 3                 | 172.31.32.0/20 | 172.31.32.0 ~ 172.31.47.255 |
| 서브넷 4                 | 172.31.48.0/20 | 172.31.48.0 ~ 172.31.63.255 |



- 인터넷 게이트웨이도 구성되어 있으므로 인터넷에 접속할 수 있다. 인터넷에 접속하고 싶지 않다면 별도의 VPC 를 생성하거나 VPC 대시보드에 접속하여 기본 VPC 를 변경해야 한다.



<br>

***

### 서브넷과 DHCP: 사용할 범위 선택

![subnets-diagram](https://user-images.githubusercontent.com/50399804/134224524-d87c0175-13aa-4f2d-b4bc-969e41a512d5.png)

- VPC를 사용하려면 서브넷에 대한 지식이 있어야 한다.

  

- 서브넷은 물리적인 위치와 관계가 있기 때문에 구조에 대해 잘 이해해야 하며, 서브넷은 CIDR 표기를 사용한다.



- 서브넷은 커다란 네트워크를 작게 나눈 네트워크를 말하며, 네트워크를 분할 해 직접 통신할 수 있는 범위를 좁히고, 방화벽을 설정해 보안을 강화하는 것을 목적으로 한다.

  - AWS의 어떤 가용 영역에 서브넷을 둘지 설정한다. 즉, 서브넷은 물리적인 장소를 특정한다.

    

- VPC는 사용자가 사용할 수 있는 네트워크 범위를 생성하고, 그 아래에 용도에 따라서 서브넷(작은 네트워크)를 생성한다. 

  - 서브넷을 나누어 서브넷 A는 공개하고, 서브넷 B는 비공개하는 식으로 서브넷별로 역할을 다르게 부여할 수도 있다.

    

- 일반적인 네트워크의 경우 서브넷끼리 통신하려면 라우팅이 필요하지만, VPC의 경우에는 라우팅 없이도 통신할 수 있다.



- 네트워크와 서브넷의 범위를 나누는 데 사용되는 표기법을 CIDR(Classless Inter-Domain Routing)이라고 한다.

  - 프리픽스 표기라고도 하는데 /24, /20 처럼 네트워크 길이를 숫자로 적어서 표기한다.

    - 255.255.255.0 이나 255.255.240.0 과 같이 서브넷 마스크로 표기하는 경우도 있지만, AWS는 CIDR를 사용한다.

      

  - CIDR은 IP 주소의 수를 나타내는데 /24이면 256개, /20이면 4096개를 의미한다.

    - 자세한 설명없이 쉽게 '32 - 네트워크의 길이'의 값을 2 제곱으로 기억하면 쉽다.

      

    - 자세한 것은 [여기](https://hyoje420.tistory.com/32)를 참조하자.

      

- 일반적인 네트워크의 경우 IP 주소를 할당할 수 있는 것은 EC2 인스턴스와 RDS 인스턴스 등이다.

  

- 하지만 AWS의 VPC는 EC2 인스턴스나 RDS 인스턴스 외에도 라우터나 인터넷 게이트웨이의 IP 주소로도 예약 주소를 사용할 수 있다.

  - 서브넷의 첫 번째부터 네 번쨰까지의  IP 주소 4개와 마지막 IP 주소는 AWS에 예약된 IP 주소이기 때문에 사용할 수 없다.

    

  - 사용할 수 있는 IP 주소가 256개라면 5개를 뺸 251개가 실제로 사용할 수 있는 IP 주소가 된다.

    

- 네트워크 및 서브넷에 사용되는 IP 주소의 범위는 관리자가 설정할 수 있고, DHCP(Dynamic Host Configuration Protocol) 에서 각 호스트(인스턴스)에 IP 주소를 자동으로 할당한다.

  

- VPC에는 DHCP 서버가 동작하고 있어 인스턴스가 추가되면 해당 서브넷 범위의 IP 주소 중에 하나가 할당된다. 

  

- VPC가 일반적으로 사용하는 IP 주소는 사설 IP 주소이다.



> DHCP란?
>
> - 사용할 수 있는 IP 주소 풀을 보유하고 있어, 클라이언트에게 자동으로 IP를 할당하는 서버

