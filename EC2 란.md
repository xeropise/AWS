### Amazon EC2 : 짧은 시간에 실행 환경을 구축할 수 있는 가상 서버

![ec2](https://user-images.githubusercontent.com/50399804/135098759-4fbfb1aa-9bf9-4318-ab19-1c0806d73bc8.png)

- Amazon Elastic Compute Cloud(Amazon EC2)는 컴퓨팅 용량을 제공하는 서비스, 쉽게 말해 서버에 필요한 세트를 클라우드에서 빌릴 수 있다.



- 임대 서버는 이미 만들어진 서버 기계나 서버 기능을 빌리는 것이지만, 클라우드의 경우는 빌린 도구를 사용하여 자신의 서버를 만든다고 생각하면 된다.



- 클라우드는 하드웨어의 구성과 OS의 조합을 탄력적으로 선택할 수 있고 구축이 쉽다는 특징이 있다.



- 착각할 수 있지만 EC2는 매니지드 서비스가 아니다. 서버 및 네트워크 운영은 AWS가 담당하지만, OS를 포함하여 필요한 소프트웨어는 사용자가 직접 설치하고 운영해야 한다.

  

- 매니지드 서비스가 아니므로 AWS에 의해 강제로 업데이트되지 않으므로 자유도가 높은 반면 관리하기는 번거로운 서비스이다.

  

- EC2 는 서버를 직접 만든다고는 하지만 관리 콘솔에서 클릭 한 번으로 생성 가능하기 때문에 기술적 지식은 그다지 필요하지 않음, 다양한 서버 시스템의 조합(인스턴스 유형)과 OS 및 소프트웨어의 조합이 준비되어 있기 때문에 이를 선택하기만 하면 된다.



- 바로 생성할 수 있고, 바로 삭제할 수 있으므로 불필요한 리소스를 유지할 필요가 없다.  다음의 경우에도 유용하다.

  - 테스트용 서버를 만들고 싶을 때

    

  - 서버 지식이 없는 사람이 서버를 만들고 싶을 때

    

  - 불확실성이 많은 경우(접속량이 얼마나 될지 모르고, 서버 사양이 얼마나 필요하지 모르는 경우.. 등)

  

- 서버에 문제가 발생한 경우에도 즉시 복구할 수 있고 복제 및 스케일 아웃, 스케일 다운 기능도 있고, 이벤트 사이트 등 일시적으로 접속이 증가하는 경우에 적합하다.

  

- EC2로 서버를 생성할 때 인스턴스 유형을 선택하여 구성할 수 있는데, 어떤 OS를 사용할 것인가, 소프트웨어를 설치할 것인가, 어떤 [AMI](https://docs.aws.amazon.com/ko_kr/AWSEC2/latest/UserGuide/AMIs.html)를 선택할 것인지에 따라 결정된다.



<br>



***

### EC2의 사용 절차 : 가상 서버를 사용하기까지



#### EC2 운영

- 서버 관리자의 업무는 서버를 설치하거나, 서버의 하드웨어 및 주변 환경을 구축하는 물리적인 작업, 그리고 서버 OS에 로그인하여 작업하는 소프트웨어적인 작업이 있다.

  

- 물리적인 작업은 클라우드 환경이 아니라면 현지에 가서 직접 케이블을 연결하여 작업하는 경우가 많지만, EC2는 관리 콘솔에서 작업할 수 있다.

  

- 소프트웨어적인 작업은 클라우드가 아닌 환경이든 EC2이든 관계없이 [SSH](https://baked-corn.tistory.com/52)를 이용해 원격으로 로그인하여 작업한다.



#### EC2 서비스의 기능

| 항목                                  | 내용                                                         |
| ------------------------------------- | ------------------------------------------------------------ |
| 인스턴스                              | AWS 클라우드에 생성한 가상 서버를 의미                       |
| AMI                                   | 가상 이미지를 말한다. 인스턴스를 생성하는 기준이 되는 틀 같은 것 |
| 키 페어                               | 인스턴스에 접속할 때 인증을 위해 사용하는 키                 |
| [EBS](https://aws.amazon.com/ko/ebs/) | AWS 클라우드에서 사용할 수 있는 스토리지, 인스턴스 스토리지로 사용한다. |
| 보안 그룹                             | 가상 방화벽으로, 1개 이상의 인스턴스 트래픽을 제한한다.      |
| Elastic IP                            | 정적(고정) IPv4 주소이다.                                    |



<br>



#### EC2의 사용 절차

- EC2를 사용하려면 관리 콘솔에서 EC2 대시보드를 열고 인스턴스를 생성해야 한다. 인스턴스가 생성되면 SSH에 접속하면 된다.

  

- 인스턴스를 만들려면 컴퓨터 사양과 OS의 종류, 소프트웨어뿐만 아니라 네트워크와 IP 주소, 보안도 설정해야 한다.

  

- 자세한 것은 [여기](https://aws.amazon.com/ko/ec2/getting-started/)를 참조하자.



<br>



#### 인스턴스 설정 항목

| 항목                                       | 내용                                                         |
| ------------------------------------------ | ------------------------------------------------------------ |
| AMI                                        | EC2 인스턴스의 가상 이미지이며, 소프트웨어 구성을 작성한 템플릿이다. |
| 인스턴스 유형                              | EC2 인스턴스의 장비 사양이다. CPU, 메모리, 장비 유형을 결정한다. |
| 리전                                       | 서버를 설치할 지역이다. 전 세계에 이중화를 고려한 경우는 다른 나라에도 설치한다. |
| 네트워크                                   | EC2 인스턴스를 배치할 네트워크이다. AWS의 VPC에서 선택한다. VPC가 없는 경우, 새로 생성하거나 기본을 사용한다. |
| 서브넷                                     | 설치할 네트워크의 범위로 VPC 내에 어떤 서브넷을 설치할지 선택한다.<br>서브넷을 선택하면 가용 영역이라고 하는 설치 장소와 어떤 범위에 사설 IP가 부여될지가 결정된다. |
| [IAM](https://aws.amazon.com/ko/iam/) 역할 | 인스턴스의 접속 권한 정책을 설정한다. 다른 서비스에 접속하고 싶을 때 할당해야 한다. |
| 스토리지의 용량과 종류                     | 서버 장비의 스토리지로 OS가 설치된 장소에 있다. <br>기본적으로 EBS를 선택하고 사용할 디스크 용량과 스토리지의 종류를 선택한다.<br>용도에 따라서는 인스턴스 스토어 (전원이 끊기면 데이터가 사라지지만 읽기 성능이 빠르다. 일부 인스턴스 유형에 대응)<br>를 선택해도 좋다. <br>S3와 같은 외부 스토리지는 선택할 수 없다. |
| 태그(EC2 인스턴스의 레이블)                | 인스턴스에 임의의 태그를 부여할 수 있다.<br>Name 태그를 사용하여 인스턴스 이름에 부여할 수 있으므로 사용하면 편리하다. |
| 보안 그룹                                  | 프로토콜별로 포트 혹은 IP 주소, 아니면 양쪽 모두 필터링을 설정한다. |



<br>



***

### 인스턴스 생성과 요금: 가상 서버 생성 예시

- 간단한 서버라면 다음 예를 참고하면 좋다 

| 항목                      | 설정 값 예시                                    |
| ------------------------- | ----------------------------------------------- |
| AMI                       | Amazon Linux2                                   |
| 인스턴스 유형             | T2.micro                                        |
| 리전                      | 서울                                            |
| 인스턴스 수               | 1                                               |
| 도입 옵션                 | 없음                                            |
| 네트워크                  | 기본 VPC                                        |
| 서브넷                    | 우선순위 없음                                   |
| 배치 그룹                 | 없음                                            |
| IAM 역할                  | 없음                                            |
| 종료 방식                 | 정지                                            |
| 삭제 보호 활성화          | 없음                                            |
| 모니터링                  | 없음                                            |
| 테넌시                    | 공유됨 - 공유된 하드웨어 인스턴스 실행          |
| T2/T3 무제한              | 없음                                            |
| 스토리지 용량 제한과 종류 | 8GB의 범용 SSD                                  |
| 태그                      | 키는 Name, 값은 Yellow Serer 등 서버 명칭       |
| 보안 그룹                 | SSH(포트 22), HTTP(포트 80), HTTPS(포트 443) 등 |



> T2/T3 무제한?
>
> - 인스턴스 유형이 T2 혹은 T3의 경우에만 한하여 표시되는 선택 사항으로 부하가 높아졌을 때 버스트(일시적으로 고성능을 낼 수 있는 기능)을 무제한으로 쓰는게 가능하다.
>
>   
>
> - 그러나 일반적으로 버스트를 초과하여 사용할 경우, 별도로 요금이 부과되기 때문에 계속해서 서버에 부하가 발생하는 경우는 예상 외로 비용이 증가할 수 있다.



<br>



#### 인스턴스의 요금

- 요금 = 인스턴스 사용량 + EBS 요금 + 통신 요금  + 그 외 옵션

  

- 인스턴스 사용량

  - 인스턴스가 가동한 시간(초) 단위로 과금된다. 정지하고 있는 동안은 과금되지 않는다. 원래 과금은 한 시간 단위였는데 2017년 9월부터 바뀌었다.

    

  - 단위는 인스턴스 유형에 따라 다르고 고기능을 사용할 경우 비싸진다.

    

- EBS(스토리지) 요금

  - 인스턴스가 사용하는 EBS 요금으로 보유한 용량 단위로 과금되며 스토리지 성능(SSD 인지, HDD인지, IOPS(Input Output Per Second: 1초간 처리할 수 있는 입출력 수) 담보를 할지 여부 등)에 따라 단가가 달라진다.

    

  - 보유한 용량 단위이며 저장 용량 단위가 아니므로 주의하자. 인스턴스와 달리 정지하고 있는 동안에도 요금이 부과된다.

  

- 통신 요금(아웃바운드 통신 요금)

  - 인스턴스의 통신 요금으로, 인터넷에서 인스턴스로 들어오는 (인바운드) 통신료는 무료이며, 인스턴스에서 인터넷으로 나가는 통신(아웃바운드)만 요금이 부과된다. 요금은 리전에 따라 조금 다르다.

  

- 그 외 옵션

  - Elastic IP 서비스 등 옵션을 사용할 경우 해당 요금이 추가된다.

  

<br>



***

### AMI: OS 및 소프트웨어가 설치된 디스크 이미지

- AMI(Amazon Machine Image)란 소프트웨어 구성을 기록한 템플릿, 한 번 만들어두면 얼마든지 같은 설정의 서버를 생성하는 것이 가능하다.

  

- 동일한 서버가 여러 개 필요할 때 서버마다 'OS를 설치하고, 아파치를 설치하고, 소프트웨어를 설치하고, 각각을 설정하고'와 같은 작업을 반복해야 하므로 시간과 노력이 많이 들지만, AMI를 사용하면 단 몇 분만에 동일한 서버를 만들 수 있다.



#### 제공되는 OS 이미지

- AMI는 AWS 공식 AMI만 있는 것이 아니다. OS나 소프트웨어의 커뮤니티판, 기업이 생성한 AMI도 제공한다.

  

- AMI에 따라서는 이용에 따라 별도 요금이 발생하는 경우도 있다.



- 리스트는 [여기](https://docs.aws.amazon.com/ko_kr/AWSEC2/latest/UserGuide/usingsharedamis-finding.html)의 방법으로 검색할 수 있다.



<br>



***

### 인스턴스 유형: 용도에 맞게 머신을 선택하자.

- 인스턴스 유형이란의 머신의 용도로 CPU, 메모리지, 스토리지, 네트워크 용량등이 용도에 맞게 조합되어 있다.



<br>



#### 인스턴스의 유형과 크기

- 유형과 크기는 아래와 같으며, 그에 따라 단가가 달라진다. 단가 x 사용 시간이 기본 요금이다.

| 용도                   | 인스턴스 유형      | 내용                                                         |
| ---------------------- | ------------------ | ------------------------------------------------------------ |
| 범용                   | T2, T3, M5, M4...  | 일반적인 서버로, 부하가 일정한 서버의 경우 사용하며, 버스트 기능을 지원하는 유형도 있다. |
| 컴퓨팅 최적화          | C5, C4...          | 연산 능력이 높은 서버이다.                                   |
| 메모리 최적화          | X1e, X1...         | 메모리 액세스 속도를 높인 서버이다.                          |
|                        | R4                 | 대용량 메모리를 탑재한 서버이다.                             |
| 가속화된 컴퓨팅 최적화 | P3, P2, G3, F1.... | 머신 러닝 등에 사용되는 GPU를 탑재한 유형 및 그래픽 기능이 높은 유형이다. |
| 스토리지 최적화        | H1, I3, D2....     | 스토리지를 최적화한 유형으로 I3는 SSD 기반이다.              |



<br>



***

### Amazon EBS: Amazon EC2의 스토리지 볼륨

- EC2와 조합하여 사용하며, 종류가 있고, 고성능과 저비용이 있으며 어느 쪽이든 선택 가능하다. SSD와 HDD 두가지가 있다.



<br>



#### EBS란

- Amazon EBS(Amazon Elastic Block Store)는 영구적인 블록 스토리지 볼륨으로 EC2 인스턴스와 조합하여 사용한다.

  

<br>



#### EBS의 기능과 요금

| 기능명                      | 내용                                                         |
| --------------------------- | ------------------------------------------------------------ |
| 탄력적 볼륨                 | 볼륨 크기를 간단히 조정할 수 있는 기능이다.                  |
| 스냅샷                      | 어떤 시점의 데이터를 통째로 저장하는 기능이다.               |
| 데이터 라이프 사이클 매니저 | 일정에 따라서 스냅샷을 생성, 삭제하는 기능이다.              |
| 최적화 인스턴스             | 특정 인스턴스 유형을 최적화 인스턴스로써 읽기 쓰기를 고속화하는 기능이다. |
| 암호화                      | 데이터 볼륨, 부팅 볼륨 및 스냅샷을 암호화하는 기능이다. <br>KMS(AWS Key Management Service, 키를 생성/관리할 수 있는 기능)을 사용할 수 있다. |



<br>



***

### Elastic IP 주소: 고정 공인 IP 주소를 부여

- AWS가 제공하는 정적인 공인(public) IPv4 주소로 EC2 인스턴스는 정지 후 다시 시작하면 공인 IP 주소가 바뀌게 된다.

  

- 이는 서버로서 사용하는 데 큰 문제가 되는데 고정 IP 주소를 인스턴스와 연결해야 하고, 이때 고정 IP로 사용되는 것인 Elastic Ip 주소이다.



<br>



#### Elastic IP 주소의 확보와 부여

- Elastic IP 주소는 AWS 계정에 연결되어 있는데 인스턴스가 단위가 아니므로 IP 주소를 부여한 인스턴스를 삭제해도 확보한 IP 주소는 그대로 AWS 계정에서 소유하는 것이 가능하다.

  

- 보유하고 있는 IP 주소는 다른 인스턴스나 네트워크에 부여할 수도 있다.

  

- 인스턴스에 이미 할당되어 있는 공인 IP 대신 Elastic IP 주소를 할당하면 AWS 공인 IPv4 주소 풀(인스턴스에 할당하기 위해 확보한 IP 주소)로 되돌아 간다.

  

- 이미 할당되어 있는 IP 주소는 Elastic IP 주소로 사용할 수 없다. 

  

- Elastic IP 주소는 리저에 속하므로 다른 리전이 보유하고 있는 Elastic IP 주소 역시 사용할 수 없다.



<br>



#### Elastic IP 주소의 요금

- Elastic IP 주소의 요금은 조금 특수한데, 기본적으로 인스턴스에 부여된 IP 한개는 무료이고, 추가로 IP를 연결하면 IP는 시간에 비례하여 요금이 부과된다.

  

- 또한, 소유한 IP가 중지된 인스턴스나 분리된 네트워크에 연결된 경우에도 시간당 요금이 부과된다.

  - 따라서 사용하지 않는 IP 주소는 해지하는 것이 좋다.



<br>



***

### Elastic Load Balancing: 트래픽을 분배하는 분산 장치

- AWS가 제공하는 로드 밸런서로 서버에 집중되는 접속(트래픽)을 서버 여러 대나 네트워크에 분배하는 방식이다.

  

- 서버 한 대에 집중되는 부하를 분산시키기 때문에 부하 분산 장치라고도 한다.



<br>



#### ELB의 종류

- ALB(Application Load Balancer)

  - HTTP 및 HTTPS에 가장 적합한 로드 밸런서로, OSI 모형의 애플리케이션 계층에서 동작한다.

    

  - 요청되는 명령어의 내용을 보고 판단하기 때문에 대상의 URL 디렉터리 단위로 분배하는 것이 가능하다.

    

  - 인스턴스와 로드 밸런서 사이의 통신은 암호화가 가능하다는 것도 특징 중 하나이다. 하지만 분배 대상으로 정적 IP 주소를 설정하고 그 IP를 가진 호스트(기기)로 전송할 수 없다.

    

  - 지원 프로토콜: HTTP, HTTPS

    

- NLB(Network Load Balancer)

  - OSI 모형의 전송 계층에서 동작한다. 패킷이라고 불리는 단편 데이터밖에 볼 수 없기 때문에 ALB만큼 상세하게 분배할 수 없다.

    

  - 대신 분배 대상의 정적 IP 주소를 설정할 수 있고, 서버에 접속한 클라이언트 IP 주소를 그대로 서버에 전송하도록 설정할 수 있다.

    

  - 지원 프로토콜 : TCP. TLS

    

- CLB(Classic Load Balancer)

  - 오래된 유형의 로드 밸런서로 지원하는 프로토콜이 많다는 것이 장점이지만 앞으로 구축할 시스템에서는 사용하지 않는 것을 권장한다.



<br>



#### ELB의 요금

- ALB와 NLB의 요금은 시간당 사용 요금과 LCU(로드 밸런서 용량 단위) 요금의 합계로 계산한다.

  - 요금 = 사용 요금 + LCU 요금

    

  - 사용 요금 : ELB의 종류별로 단가가 결정되면 여기에 시간을 곱한 금액이다.

    

  - LCU 요금 : 4가지 측정 항목에 대해서 LCU 사용량이 어떤 LCU 항목에 해당하는지 환산하고 가장 큰 항목만 과금 대상으로 한다. 마찬가지로 LCU 사용량과 단가에 시간을 곱해서 산출한다. 아래의 경우 처리 바이트의 수치가 제일 높으므로 요금 산출의 대상이 된다.

    - 새로운 연결 수 - 0.04LCU
    - 활성 연결 수 - 0.04LCU
    - 처리 바이트 - 1.08 LCU
    - 규칙 평가 - 025LCU



<br>



***

### 오토 스케일링: 수요에 맞춰 EC2 대수를 증감

- 서버의 액세스 상태에 따라 서버 대수를 늘리거나 줄이는 기능으로 EC2 외의 서비스를 지원하는 오토 스케일링도 있다.

  

- AWS는 EC2 Auto Scaling을 단독으로 사용할 뿐만 아니라 CloudWatch에서 서버의 부하 정보 데이터를 참조하여 스케일링에 참고할 수도 있다.



<br>



#### 감시와 인스턴스 수의 결정

- 오토 스케일링을 시작하려면 'Auto Scailing 그룹'(인스턴스의 집합)을 생성하고 그룹에 인스턴스(서버)의 최소 대수와 최대 대수를 설정해야 한다.

  

- 그러면 이 범위 안에서 인스턴스 수가 증가한다. Auto Scailing 그룹은 서버 시작에 필요한 AMI와 키 페어, 보안 그룹 등을 설정해야 한다.

  

- 인스턴스의 증감에는 3가지 방법이 있다.

  - EC2 인스턴스가 정지한 경우에 분리하고 새로운 EC2 인스턴스를 생성하는 방법

    

  - 일정에 맞춰 스케일링 하는 방법

    

  - CPU와 네트워크의 부하를 참고하여 특정 임계 값을 넘을 때 인스턴스 수를 자동적으로 증감하는 방법

    

- 오토 스케일링의 요금은 무료이나 Cloud Watch를 사용할 경우 모니터링에 관련된 요금이 부과된다.



<br>



***

#### 스냅샷: 서버 데이터 백업

- 스냅샷을 작성하여 Amazon EBS 볼륨의 데이터를 Amazon S3에 백업할 수 있다. 생성된 스냅샷은 바로 사용 가능한 복제본이며, 백업용으로 많이 사용된다.



- 스냅샷이란 어떤 시점의 서버 디스크 상태를 통째로 보존한 파일이나 폴더 등의 집합이다. 통째로 보존하기 때문에 데이터나 소프트웨어뿐만 아니라 OS와 설정 정보 등도 모두 포함된다.

  

- 소프트웨어나 OS 갱신 작업 등을 할 때 무언가 문제가 발생하면 바로 되돌릴 수 있도록 백업하기 위해 스냅샷을 사용하는 경우가 많다. 개인이 AWS에서 AMI를 만들기 위해 스냅샷을 사용하기도 한다.

  

- AWS는 Amazon EBS 볼륨의 데이터를 스냅샷으로 보존할 수 있다. 단, 최초에는 통째로 보존하지만 두 번째 이후는 차분(증분)만 보존한다.

  - 스냅샷의 비용이 높아지지 않도록 하기 위한 아마존의 친절함(?) 일 수 있다.

  

- 스냅샷을 삭제하면 해당 스냅샷 고유의 데이터만 삭제된다. 최초 데이터를 삭제할 경우, 두 번째 스냅샷을 취득했을 때 변경되지 않은 부분(고유 데이터)만 두 번째 스냅샷으로 합쳐진 후 삭제된다.

  

<br>



#### EBS 스냅샷을 생성하는 방법

- 스냅샷은 관리 콘솔에서 볼륨 단위(스토리지 전체)로 선택하여 생성한다.

  

- 생성한 스냅샷을 기반으로 EBS 볼륨을 생성하면 새로운 볼륨은 원래 볼륨의 복제가 된다.

  

- AMI를 작성하고 싶을 때도 스냅샷으로 작성한다.

  

- 데이터 수명 주기 관리자(Amazon DLM)을 사용하면 스냅샷의 생성, 삭제를 자동화할 수 있다. 스냅샷을 정기적으로 생성하면 서버가 망가졌을 때 대응할 수 있다.

  

- 스냅샷의 요금은 생성한 스냅샷의 분량 단위(GB 단위)로 발생한다.



